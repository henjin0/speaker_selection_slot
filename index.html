<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>発表者決めルーレット</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    :root { --cell: 120px; }
    body { background:#0e0f12; color:#e9ecef; }
    .app-wrap { min-height: 100svh; display:grid; place-items:center; padding:2rem 1rem; }
    .slot { width:min(820px,100%); }
    .reels { display:flex; justify-content:center; gap:2rem; align-items:center; }
    .reel-wrap { position:relative; height: var(--cell); width: var(--cell); overflow:hidden; border-radius: 1rem; box-shadow: 0 10px 30px rgba(0,0,0,.45), inset 0 0 0 2px rgba(255,255,255,.08); background: linear-gradient(180deg,#1b1f29,#111318); }
    .window-gloss::after{ content:""; position:absolute; inset:0; background: radial-gradient(120% 60% at 50% -10%, rgba(255,255,255,.10), transparent 50%); pointer-events:none; }
    .strip { position:absolute; inset:0 auto 0 0; width:100%; will-change: transform; }
    .cell { height: var(--cell); display:grid; place-items:center; font-weight:800; font-size: calc(var(--cell) * .55); letter-spacing:.04em; user-select:none; }
    .controls { display:grid; grid-template-columns: 1fr; gap: .75rem; justify-items:center; margin-top:1.25rem; }
    .btn-wide { min-width: 220px; border-radius:.85rem; font-weight:700; letter-spacing:.06em; padding:.85rem 1.25rem; box-shadow: 0 .5rem 1.25rem rgba(0,0,0,.35); }
    .sub-controls { display:grid; grid-template-columns: 1fr 1fr; gap: .75rem; width:min(520px,100%); }
    .kbd-tip { opacity:.7; font-size:.925rem; }
  </style>
</head>
<body>
  <main class="app-wrap">
    <div class="container text-center slot">
      <h1 class="mb-4 h3">発表者決定スロット！</h1>
      <section class="reels mx-auto">
        <div class="reel-wrap window-gloss" aria-live="polite" aria-label="左リール A〜F">
          <div id="stripA" class="strip"></div>
        </div>
        <div class="reel-wrap window-gloss" aria-live="polite" aria-label="右リール 1〜6">
          <div id="stripB" class="strip"></div>
        </div>
      </section>
      <div class="controls">
        <button id="btnStart" class="btn btn-success btn-wide">回す</button>
        <div class="sub-controls">
          <button id="btnStopA" class="btn btn-danger" disabled>停止</button>
          <button id="btnStopB" class="btn btn-danger" disabled>停止</button>
        </div>
        <div class="kbd-tip">スペース: 回す / 左矢印: テーブル決定 / 右矢印: 番号決定</div>
      </div>
    </div>
  </main>

  <script>

    function getRandomInt(min, max) {
        const minCeiled = Math.ceil(min);
        const maxFloored = Math.floor(max);
        return Math.floor(Math.random() * (maxFloored - minCeiled) + minCeiled); // 上限は除き、下限は含む
    }

    (function(){
      const SYMBOLS_A = ["A","B","C"];
      const SYMBOLS_B = ["1","2","3","4"];
      const CELL = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--cell')) || 120;
      const REPEAT = 18;
      const SPIN_SPEED = 1800;
      const MIN_SPEED = 180;
      const DECEL = 1400;
      const EXTRA_LAPS = getRandomInt(1,5);
      const $ = (s)=>document.querySelector(s);

      class Reel {
        constructor(stripEl, symbols){
          this.stripEl = stripEl; this.symbols = symbols;
          this.totalSymbols = symbols.length * REPEAT;
          this.totalHeight = this.totalSymbols * CELL;
          this.pos = 0; this.speed = 0; this.spinning = false; this.stopping = false; this.targetPos = 0; this.value = symbols[0];
          this._build(); this.render();
        }
        _build(){
          const frag = document.createDocumentFragment();
          for(let r=0;r<REPEAT;r++) for(const s of this.symbols){
            const div=document.createElement('div');div.className='cell';div.textContent=s;frag.appendChild(div);
          }
          this.stripEl.innerHTML='';this.stripEl.appendChild(frag);
        }
        modPos(x){ x%=this.totalHeight; return x<0?x+this.totalHeight:x; }
        render(){ this.stripEl.style.transform=`translateY(${-this.modPos(this.pos)}px)`; }
        start(){ if(this.spinning)return; this.spinning=true; this.stopping=false; this.speed=SPIN_SPEED*(0.65+Math.random()*0.3); }
        stopRandom(){ if(!this.spinning||this.stopping)return; const pickIdx=Math.floor(Math.random()*this.symbols.length); this.value=this.symbols[pickIdx]; const nowIdx=Math.floor(this.pos/CELL); let targetIdx=nowIdx+EXTRA_LAPS; const mod=((targetIdx%this.symbols.length)+this.symbols.length)%this.symbols.length; const deltaToSymbol=(pickIdx-mod+this.symbols.length)%this.symbols.length; targetIdx+=deltaToSymbol; this.targetPos=targetIdx*CELL; this.stopping=true; }
        update(dt){ if(!this.spinning)return; if(this.stopping){ this.speed=Math.max(this.speed-DECEL*dt,MIN_SPEED); const cur=this.modPos(this.pos); const tgt=this.modPos(this.targetPos); let dist=tgt-cur; if(dist<0)dist+=this.totalHeight; if(dist<Math.max(this.speed*dt*1.2,4)){ this.pos=this.targetPos; this.render(); this.spinning=false; this.stopping=false; this.speed=0; return; } } this.pos+=this.speed*dt; this.render(); }
      }

      const reelA = new Reel($('#stripA'), SYMBOLS_A);
      const reelB = new Reel($('#stripB'), SYMBOLS_B);
      const btnStart = $('#btnStart');
      const btnStopA = $('#btnStopA');
      const btnStopB = $('#btnStopB');
      let running = false;

      function setUI(){ btnStart.disabled = running && !(reelA.spinning===false && reelB.spinning===false); btnStopA.disabled = !reelA.spinning || reelA.stopping; btnStopB.disabled = !reelB.spinning || reelB.stopping; }
      function startAll(){ if(running)return; reelA.start(); reelB.start(); running=true; btnStart.classList.remove('btn-success'); btnStart.classList.add('btn-secondary'); btnStart.textContent='回転中…'; setUI(); }
      function stopA(){ reelA.stopRandom(); setUI(); maybeFinish(); }
      function stopB(){ reelB.stopRandom(); setUI(); maybeFinish(); }
      function maybeFinish(){ if(!reelA.spinning && !reelB.spinning && !reelA.stopping && !reelB.stopping && running){ running=false; btnStart.classList.remove('btn-secondary'); btnStart.classList.add('btn-success'); btnStart.textContent='回す（両リール）'; setUI(); } }

      let last=performance.now();
      function loop(now){ const dt=Math.min((now-last)/1000,0.05); last=now; reelA.update(dt); reelB.update(dt); maybeFinish(); requestAnimationFrame(loop); }
      requestAnimationFrame(loop);

      btnStart.addEventListener('click', startAll);
      btnStopA.addEventListener('click', stopA);
      btnStopB.addEventListener('click', stopB);

      window.addEventListener('keydown', (e)=>{
        if(e.code==='Space'){ e.preventDefault(); if(!running) startAll(); }
        if(e.code==='ArrowLeft'){ e.preventDefault(); stopA(); }
        if(e.code==='ArrowRight'){ e.preventDefault(); stopB(); }
      });
    })();
  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>

